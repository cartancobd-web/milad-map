<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ğŸ•Œ Milad Finder Bangladesh</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f4f9f4;}
header{background:#0a5c36;color:white;padding:15px;text-align:center;font-size:18px;}
button{background:#0a5c36;color:white;padding:10px;border:none;border-radius:8px;width:100%;margin-top:8px;}
input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;}
#map{height:300px;margin-top:10px;}
.card{background:white;padding:10px;margin:8px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.bottom{position:fixed;bottom:0;width:100%;display:flex;}
.bottom button{flex:1;border-radius:0;}
.userBar{background:#e8f5e9;padding:8px;text-align:center;font-size:14px;}
.logoutBtn{background:red;margin-top:5px;}
.deleteBtn{background:#b71c1c;margin-top:5px;}
.desc{margin-top:5px;font-size:14px;color:#333;}
.filterBox{padding:10px;background:#fff;}
#suggestions button{background:#eee;color:#000;}
</style>
</head>

<body>

<header>ğŸ•Œ Milad Finder Bangladesh</header>

<div id="loginSection">
<button onclick="googleLogin()">Login With Google</button>
</div>

<div id="main" style="padding-bottom:60px;">

<div class="userBar" id="userBar" style="display:none;">
ğŸ‘¤ <span id="userName"></span>
<button class="logoutBtn" onclick="logout()">Logout</button>
</div>

<div id="createTab" style="display:none;">
<h3>Create Milad</h3>

<input type="text" id="mosqueName" placeholder="Mosque Name"/>
<div id="suggestions"></div>

<input type="text" id="address" placeholder="Address Auto"/>
<input type="date" id="date"/>
<input type="time" id="time"/>
<input type="text" id="description" placeholder="Description"/>
<button onclick="createMilad()">Create Milad</button>
</div>

<div id="checkTab">
<h3>Milad Check</h3>

<div class="filterBox">
ğŸ“… Filter by Date:
<input type="date" id="filterDate" onchange="loadMilads()"/>
</div>

<div id="list"></div>
<div id="map"></div>
</div>

</div>

<div class="bottom">
<button onclick="showCreate()">Create Milad</button>
<button onclick="showCheck()">Milad Check</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "YOUR_KEY",
authDomain: "YOUR_DOMAIN",
projectId: "YOUR_ID",
storageBucket: "YOUR_BUCKET",
messagingSenderId: "YOUR_MSG_ID",
appId: "YOUR_APP_ID",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let userLat,userLng,map;
let markers=[];

/* LOCATION */
window.addEventListener("load",()=>{
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(async pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;
loadMilads();
loadNearbyMosques();
getAddress();
});
}
});

/* AUTO LOGIN STATE */
onAuthStateChanged(auth,(user)=>{
if(user){
loginSection.style.display="none";
userBar.style.display="block";
userName.innerText=user.displayName;
}else{
loginSection.style.display="block";
userBar.style.display="none";
}
});

/* LOGIN */
window.googleLogin=async function(){
const provider=new GoogleAuthProvider();
await signInWithPopup(auth,provider);
};

/* LOGOUT */
window.logout=async function(){
await signOut(auth);
};

/* TAB */
window.showCreate=function(){
if(!auth.currentUser){alert("Login Required");return;}
createTab.style.display="block";
checkTab.style.display="none";
}

window.showCheck=function(){
createTab.style.display="none";
checkTab.style.display="block";
loadMilads();
}

/* CREATE */
window.createMilad=async function(){
const user=auth.currentUser;
if(!user){alert("Login Required");return;}

await addDoc(collection(db,"milads"),{
mosque:mosqueName.value,
address:address.value,
date:date.value,
time:time.value,
desc:description.value,
lat:userLat,
lng:userLng,
likes:0,
user:user.displayName,
uid:user.uid
});
alert("Milad Posted");
}

/* LOAD MILADS (Login à¦›à¦¾à§œà¦¾ à¦•à¦¾à¦œ à¦•à¦°à¦¬à§‡) */
window.loadMilads=async function(){
const snapshot=await getDocs(collection(db,"milads"));
list.innerHTML="";
const selectedDate=filterDate.value;

snapshot.forEach(docSnap=>{
const data=docSnap.data();
const distance=getDistance(userLat,userLng,data.lat,data.lng);

if(distance<=5 && (!selectedDate || selectedDate===data.date)){

let deleteBtn="";
if(auth.currentUser && auth.currentUser.uid===data.uid){
deleteBtn=`<button class="deleteBtn" onclick="deleteMilad('${docSnap.id}')">Delete</button>`;
}

const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<b>${data.mosque}</b><br>
ğŸ“ ${data.address}<br>
ğŸ“… ${data.date} â° ${data.time}<br>
ğŸ‘¤ ${data.user}<br>
ğŸ“ ${distance.toFixed(2)} KM<br>
<div class="desc">${data.desc}</div>
â¤ï¸ ${data.likes}
<button onclick="likeMilad('${docSnap.id}',${data.likes})">Like</button>
${deleteBtn}
`;
list.appendChild(div);
}
});
initMap(snapshot);
};

/* DELETE */
window.deleteMilad=async function(id){
if(confirm("Delete this post?")){
await deleteDoc(doc(db,"milads",id));
loadMilads();
}
};

/* LIKE */
window.likeMilad=async function(id,current){
if(!auth.currentUser){alert("Login Required");return;}
const likeId=id+"_"+auth.currentUser.uid;
const likeRef=doc(db,"likes",likeId);
if((await getDoc(likeRef)).exists()){alert("Already Liked");return;}
await setDoc(likeRef,{miladId:id});
await updateDoc(doc(db,"milads",id),{likes:current+1});
loadMilads();
};

/* MAP */
function initMap(snapshot){
if(!map){
map=L.map('map').setView([userLat,userLng],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}
markers.forEach(m=>map.removeLayer(m));
markers=[];
snapshot.forEach(docSnap=>{
const data=docSnap.data();
if(getDistance(userLat,userLng,data.lat,data.lng)<=5){
const marker=L.marker([data.lat,data.lng]).addTo(map).bindPopup(data.mosque);
markers.push(marker);
}
});
}

/* DISTANCE */
function getDistance(lat1,lon1,lat2,lon2){
const R=6371;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* MOSQUE AUTO SUGGEST */
async function loadNearbyMosques(){
const response=await fetch(
`https://overpass-api.de/api/interpreter?data=[out:json];node["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${userLat},${userLng});out;`
);
const data=await response.json();
suggestions.innerHTML="";
data.elements.slice(0,8).forEach(m=>{
if(m.tags && m.tags.name){
const btn=document.createElement("button");
btn.innerText=m.tags.name;
btn.onclick=()=>{
mosqueName.value=m.tags.name;
suggestions.innerHTML="";
};
suggestions.appendChild(btn);
}
});
}

/* AUTO ADDRESS */
async function getAddress(){
const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLng}`);
const data=await res.json();
address.value=data.display_name;
}

</script>

</body>
</html>
