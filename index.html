<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üïå Milad Map Bangladesh</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(180deg,#063d1e,#0d5c2a);
color:white;
padding:10px;
}

h1{text-align:center;color:gold;}
.top{text-align:center;margin-bottom:10px;}

.tabs{display:flex;gap:10px;margin-bottom:10px;}
.tabbtn{
flex:1;padding:10px;border:none;border-radius:10px;
background:gold;font-weight:bold;cursor:pointer;
}
.tabbtn.active{background:#ffd700;}
.tabcontent{display:none;}
.tabcontent.active{display:block;}

#map,#nearbyMap{
height:320px;border-radius:15px;margin-bottom:15px;
}

.card{
background:white;color:black;padding:15px;
border-radius:15px;margin-bottom:15px;
box-shadow:0 4px 10px rgba(0,0,0,0.3);
}

button{
padding:8px 12px;background:gold;border:none;
border-radius:8px;font-weight:bold;cursor:pointer;
}

input{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;}

@media(max-width:600px){
#map,#nearbyMap{height:250px;}
}
</style>
</head>

<body>

<div class="top">
<h1>üïå Milad Map Bangladesh</h1>
<button id="loginBtn">Login with Google</button>
<p id="userInfo"></p>
</div>

<div class="tabs">
<button class="tabbtn active" onclick="openTab('postTab',this)">‚ûï Post</button>
<button class="tabbtn" onclick="openTab('nearbyTab',this)">üìç Nearby</button>
</div>

<div id="postTab" class="tabcontent active">

<div id="map"></div>

<div class="card">
<h3>‡¶Æ‡¶ø‡¶≤‡¶æ‡¶¶ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
<form id="postForm">
<input type="text" id="mosque" placeholder="‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ" required>
<input type="text" id="district" placeholder="‡¶ú‡ßá‡¶≤‡¶æ (Auto)" required>
<input type="text" id="food" placeholder="‡¶ï‡¶ø ‡¶ñ‡¶æ‡¶ì‡ßü‡¶æ ‡¶¶‡¶ø‡¶¨‡ßá" required>
<input type="date" id="date" required>
<input type="time" id="time" required>
<button type="submit">Publish</button>
</form>
</div>

</div>

<div id="nearbyTab" class="tabcontent">
<div id="nearbyMap"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAETli2UtjPzEU5xd9U6_W7xeJxBGq3xV8",
  authDomain: "milad-4727b.firebaseapp.com",
  projectId: "milad-4727b",
  storageBucket: "milad-4727b.firebasestorage.app",
  messagingSenderId: "1088600725533",
  appId: "1:1088600725533:web:f4bdacb68606f846590ef4",
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

const now = new Date();
date.value = now.toISOString().split('T')[0];
time.value =
now.getHours().toString().padStart(2,'0') + ":" +
now.getMinutes().toString().padStart(2,'0');

let userLat,userLon;
let map, nearbyMap;
let circle;

function getDistance(lat1,lon1,lat2,lon2){
const R=6371;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

navigator.geolocation.getCurrentPosition(async pos=>{

userLat=pos.coords.latitude;
userLon=pos.coords.longitude;

map=L.map('map').setView([userLat,userLon],14);
nearbyMap=L.map('nearbyMap').setView([userLat,userLon],14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(nearbyMap);

L.marker([userLat,userLon]).addTo(map).bindPopup("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®");
L.marker([userLat,userLon]).addTo(nearbyMap);

circle=L.circle([userLat,userLon],{
radius:5000,
color:'gold',
fillOpacity:0.1
}).addTo(nearbyMap);

const geoRes=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userLat}&lon=${userLon}`);
const geoData=await geoRes.json();
district.value=geoData.address.state_district || geoData.address.state || "";

loadPosts();

});

function loadPosts(){

onSnapshot(collection(db,"milads"), snapshot=>{

nearbyMap.eachLayer(layer=>{
if(layer instanceof L.Marker && layer.getLatLng){
nearbyMap.removeLayer(layer);
}
});

L.marker([userLat,userLon]).addTo(nearbyMap);

let topLiked=0;
let topDoc=null;

snapshot.forEach(docSnap=>{
const d=docSnap.data();
if((d.likes||0)>topLiked){
topLiked=d.likes;
topDoc=d;
}
});

snapshot.forEach(docSnap=>{
const d=docSnap.data();
const distance=getDistance(userLat,userLon,d.lat,d.lon);

if(distance<=5){

const marker=L.marker([d.lat,d.lon]).addTo(nearbyMap);

let trending="";
if(d===topDoc){
trending="üî• Top Trending<br>";
}

marker.bindPopup(`
${trending}
<b>${d.mosque}</b><br>
üìç ${distance.toFixed(2)} km ‡¶¶‡ßÇ‡¶∞‡ßá<br>
‚ù§Ô∏è ${d.likes||0}
<button onclick="likePost('${docSnap.id}')">Like</button>
`);
}
});
});
}

window.likePost=async function(id){
const ref=doc(db,"milads",id);
await updateDoc(ref,{likes:increment(1)});
};

loginBtn.onclick=async ()=>{
try{
const result=await signInWithPopup(auth,provider);
userInfo.innerText="Logged in: "+result.user.displayName;
}catch(e){alert(e.message);}
};

postForm.addEventListener("submit",async e=>{
e.preventDefault();
if(!auth.currentUser){alert("Login ‡¶ï‡¶∞‡ßÅ‡¶®");return;}

await addDoc(collection(db,"milads"),{
mosque:mosque.value,
district:district.value,
food:food.value,
date:date.value,
time:time.value,
lat:userLat,
lon:userLon,
likes:0,
user:auth.currentUser.displayName
});
alert("Published!");
});

</script>

<script>
function openTab(tabId,btn){
document.querySelectorAll('.tabcontent').forEach(t=>t.classList.remove('active'));
document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
document.getElementById(tabId).classList.add('active');
btn.classList.add('active');
}
</script>

</body>
</html>
