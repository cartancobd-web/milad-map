<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>üïå Milad Finder Bangladesh</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#f4f9f4;}
header{background:#0a5c36;color:white;padding:15px;text-align:center;font-size:20px;}
button{background:#0a5c36;color:white;padding:10px;border:none;border-radius:8px;width:100%;margin-top:8px;}
input{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;}
#map{height:300px;margin-top:10px;}
.card{background:white;padding:10px;margin:8px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.bottom{position:fixed;bottom:0;width:100%;display:flex;}
.bottom button{flex:1;border-radius:0;}
#suggestions button{background:#eee;color:#000;margin-top:5px;}
</style>
</head>
<body>

<header>üïå Milad Finder</header>

<div id="loginSection">
<button onclick="googleLogin()">Login With Google</button>
</div>

<div id="main" style="display:none;padding-bottom:60px;">

<div id="createTab">
<h3>Create Milad</h3>

<input type="text" id="mosqueName" placeholder="Mosque Name"/>
<div id="suggestions"></div>

<input type="date" id="date"/>
<input type="time" id="time"/>
<input type="text" id="description" placeholder="Description"/>

<button onclick="createMilad()">Post Milad</button>
</div>

<div id="checkTab" style="display:none;">
<h3>Nearby Milad (5KM)</h3>
<div id="list"></div>
<div id="map"></div>
</div>

</div>

<div class="bottom">
<button onclick="showCreate()">Create</button>
<button onclick="showCheck()">Check</button>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
apiKey: "AIzaSyAETli2UtjPzEU5xd9U6_W7xeJxBGq3xV8",
authDomain: "milad-4727b.firebaseapp.com",
projectId: "milad-4727b",
storageBucket: "milad-4727b.firebasestorage.app",
messagingSenderId: "1088600725533",
appId: "1:1088600725533:web:f4bdacb68606f846590ef4",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let userLat,userLng,map;
let markers=[];

/* AUTO LOCATION */
window.addEventListener("load",()=>{
if(navigator.geolocation){
navigator.geolocation.getCurrentPosition(pos=>{
userLat=pos.coords.latitude;
userLng=pos.coords.longitude;
},()=>alert("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡¶® ‡¶®‡¶æ ‡¶ï‡¶∞‡¶≤‡ßá ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶®‡¶æ"));
}
});

/* AUTO LOGIN DETECT */
onAuthStateChanged(auth,(user)=>{
if(user){
document.getElementById("loginSection").style.display="none";
document.getElementById("main").style.display="block";
loadMilads();
}
});

/* GOOGLE LOGIN */
window.googleLogin=async function(){
const provider=new GoogleAuthProvider();
await signInWithPopup(auth,provider);
};

/* CREATE MILAD */
window.createMilad=async function(){
const user=auth.currentUser;
if(!user){alert("Login Required");return;}

await addDoc(collection(db,"milads"),{
mosque:mosqueName.value,
date:date.value,
time:time.value,
desc:description.value,
lat:userLat,
lng:userLng,
likes:0
});
alert("Milad Posted");
};

/* SHOW TAB */
window.showCreate=function(){
createTab.style.display="block";
checkTab.style.display="none";
loadNearbyMosques();
}
window.showCheck=function(){
createTab.style.display="none";
checkTab.style.display="block";
loadMilads();
}

/* LOAD MILADS */
async function loadMilads(){
const snapshot=await getDocs(collection(db,"milads"));
list.innerHTML="";
snapshot.forEach(docSnap=>{
const data=docSnap.data();
const distance=getDistance(userLat,userLng,data.lat,data.lng);
if(distance<=5){
const div=document.createElement("div");
div.className="card";
div.innerHTML=`
<b>${data.mosque}</b><br>
${data.date} ${data.time}<br>
Distance: ${distance.toFixed(2)} KM<br>
‚ù§Ô∏è ${data.likes}
<button onclick="likeMilad('${docSnap.id}',${data.likes})">Like</button>
`;
list.appendChild(div);
}
});
initMap(snapshot);
}

/* ONE USER ONE LIKE */
window.likeMilad=async function(id,current){
const user=auth.currentUser;
if(!user){alert("Login Required");return;}
const likeId=id+"_"+user.uid;
const likeRef=doc(db,"likes",likeId);
const likeSnap=await getDoc(likeRef);
if(likeSnap.exists()){alert("Already Liked");return;}
await setDoc(likeRef,{miladId:id,userId:user.uid});
await updateDoc(doc(db,"milads",id),{likes:current+1});
loadMilads();
}

/* MAP */
function initMap(snapshot){
if(!map){
map=L.map('map').setView([userLat,userLng],13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
}
markers.forEach(m=>map.removeLayer(m));
markers=[];
snapshot.forEach(docSnap=>{
const data=docSnap.data();
const marker=L.marker([data.lat,data.lng]).addTo(map).bindPopup(data.mosque);
markers.push(marker);
});
}

/* DISTANCE */
function getDistance(lat1,lon1,lat2,lon2){
const R=6371;
const dLat=(lat2-lat1)*Math.PI/180;
const dLon=(lon2-lon1)*Math.PI/180;
const a=Math.sin(dLat/2)**2+
Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
Math.sin(dLon/2)**2;
return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}

/* NEARBY MOSQUE SUGGEST */
async function loadNearbyMosques(){
if(!userLat)return;
const response=await fetch(
`https://overpass-api.de/api/interpreter?data=[out:json];node["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${userLat},${userLng});out;`
);
const data=await response.json();
suggestions.innerHTML="";
data.elements.slice(0,8).forEach(m=>{
if(m.tags && m.tags.name){
const btn=document.createElement("button");
btn.innerText=m.tags.name;
btn.onclick=()=>{
mosqueName.value=m.tags.name;
suggestions.innerHTML="";
};
suggestions.appendChild(btn);
}
});
}

</script>

<footer style="text-align:center;padding:20px;">
Created By Tariqul Islam<br>
<a href="https://facebook.com/3tariqul" target="_blank">Facebook Check</a>
</footer>

</body>
</html>
