<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>üïå Milad Map Bangladesh</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body{
margin:0;
font-family:'Segoe UI',sans-serif;
background:linear-gradient(180deg,#063d1e,#0d5c2a);
color:white;
padding:10px;
}

h1{
text-align:center;
color:gold;
margin-bottom:5px;
}

.top{
text-align:center;
margin-bottom:10px;
}

#map{
height:320px;
border-radius:15px;
margin-bottom:15px;
}

.card{
background:white;
color:black;
padding:15px;
border-radius:15px;
margin-bottom:15px;
box-shadow:0 4px 10px rgba(0,0,0,0.3);
}

button{
padding:10px;
background:gold;
border:none;
border-radius:8px;
font-weight:bold;
cursor:pointer;
}

select,input{
width:100%;
padding:10px;
margin-bottom:10px;
border-radius:8px;
border:1px solid #ccc;
}

@media(max-width:600px){
#map{height:250px;}
}
</style>
</head>

<body>

<div class="top">
<h1>üïå Milad Map Bangladesh</h1>
<button id="loginBtn">Login with Google</button>
<p id="userInfo"></p>
</div>

<div id="map"></div>

<div class="card">
<h3>‡¶®‡¶ø‡¶ï‡¶ü‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
<select id="mosqueSelect">
<option value="">‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</option>
</select>
</div>

<div class="card">
<h3>‡¶Æ‡¶ø‡¶≤‡¶æ‡¶¶ ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h3>
<form id="postForm">
<input type="text" id="district" placeholder="‡¶ú‡ßá‡¶≤‡¶æ" required>
<input type="text" id="food" placeholder="‡¶ï‡¶ø ‡¶ñ‡¶æ‡¶ì‡ßü‡¶æ ‡¶¶‡¶ø‡¶¨‡ßá" required>
<input type="date" id="date" required>
<input type="time" id="time" required>
<button type="submit">Publish</button>
</form>
</div>

<script type="module">

// Firebase Import
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, signInWithPopup, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
apiKey: "AIzaSyAETli2UtjPzEU5xd9U6_W7xeJxBGq3xV8",
authDomain: "milad-4727b.firebaseapp.com",
projectId: "milad-4727b",
storageBucket: "milad-4727b.firebasestorage.app",
messagingSenderId: "1088600725533",
appId: "1:1088600725533:web:f4bdacb68606f846590ef4"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const provider = new GoogleAuthProvider();

// Auto Date & Time
const now = new Date();
document.getElementById("date").value = now.toISOString().split('T')[0];
document.getElementById("time").value =
now.getHours().toString().padStart(2,'0') + ":" +
now.getMinutes().toString().padStart(2,'0');

let userLat,userLon;
let map;

// Get Location
navigator.geolocation.getCurrentPosition(async pos=>{

userLat = pos.coords.latitude;
userLon = pos.coords.longitude;

map = L.map('map').setView([userLat,userLon],14);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
.addTo(map);

L.marker([userLat,userLon])
.addTo(map)
.bindPopup("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶®")
.openPopup();

loadNearbyMosques();

},()=>{
alert("‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶Ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®");
});

// Overpass API Mosque Fetch
async function loadNearbyMosques(){

const url = `
https://overpass-api.de/api/interpreter?data=
[out:json];
node["amenity"="place_of_worship"]["religion"="muslim"]
(around:3000,${userLat},${userLon});
out;`;

const res = await fetch(url);
const data = await res.json();

const select = document.getElementById("mosqueSelect");
select.innerHTML = "<option value=''>‡¶Æ‡¶∏‡¶ú‡¶ø‡¶¶ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</option>";

data.elements.forEach(m=>{
if(m.tags && m.tags.name){
const opt = document.createElement("option");
opt.value = m.tags.name;
opt.textContent = m.tags.name;
select.appendChild(opt);

L.marker([m.lat,m.lon])
.addTo(map)
.bindPopup("üïå "+m.tags.name);
}
});

}

// Google Login
document.getElementById("loginBtn")
.addEventListener("click",async()=>{
try{
const result = await signInWithPopup(auth,provider);
document.getElementById("userInfo").innerText =
"Logged in: "+result.user.displayName;
}catch(e){
alert(e.message);
}
});

// Post Submit
document.getElementById("postForm")
.addEventListener("submit",async e=>{
e.preventDefault();

if(!auth.currentUser){
alert("Login ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá");
return;
}

await addDoc(collection(db,"milads"),{
mosque: mosqueSelect.value,
district: district.value,
food: food.value,
date: date.value,
time: time.value,
lat: userLat,
lon: userLon,
user: auth.currentUser.displayName
});

alert("Post Published!");
location.reload();
});

</script>

</body>
</html>
